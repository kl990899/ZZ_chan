<!-- 樣式已移至 application.css -->

<% content_for :title, "討論板首頁" %>
<% content_for :description, "Zz Chan 討論板首頁，瀏覽最新的討論串和熱門話題，參與社群討論。" %>
<% content_for :og_type, "website" %>

<% content_for :structured_data do %>
  <script type="application/ld+json">
    <%= structured_data_breadcrumb([
      { name: "首頁", url: root_url },
      { name: "討論板", url: discussion_threads_url }
    ]) %>
  </script>
<% end %>

<h1>討論板</h1>

<!-- 建立新討論串表單 -->
<div class="thread-form">
  <%= form_with model: @discussion_thread, local: true do |form| %>
    <div class="form-group">
      <%= form.label :name, "發文者名稱 (可選)" %>
      <%= form.text_field :name, class: "form-control", placeholder: "留空則顯示為匿名" %>
    </div>
    <div class="form-group">
      <%= form.label :title, "討論串標題 (可選)" %>
      <%= form.text_field :title, class: "form-control", placeholder: "留空則顯示為無題" %>
    </div>
    <div class="form-group">
      <%= form.label :content, "內容" %>
      <%= form.text_area :content, class: "form-control", rows: 3, placeholder: "請輸入討論內容..." %>
    </div>
    <div class="form-group file-upload-group">
      <label class="form-label">上傳圖片或影片 (可選)</label>
      <div class="file-upload-container">
        <%= form.file_field :file, class: "form-control file-input", accept: "image/*,video/*" %>
        <small class="file-format-text">支援格式：圖片 (JPEG, PNG, GIF, WebP) 或影片 (MP4, WebM)</small>
      </div>
      <div class="submit-container">
        <%= form.submit "建立討論串", class: "btn submit-btn" %>
      </div>
    </div>
  <% end %>
</div>

<!-- 討論串列表 -->
<ul class="thread-list">
  <% @discussion_threads.each do |thread| %>
    <% thread_data = discussion_thread_data(thread, view: :show) %>
    <li class="thread-item">
      <div class="thread-header">
        <h2 class="thread-title">
          <%= link_to thread_data[:title].presence || "無題", discussion_thread_path(thread) %>
        </h2>
        <div class="thread-meta">
          <span>發文者: <%= thread_data[:name] %></span>
          <span>ID: <%= thread_data[:hash_ip] %></span>
          <span><%= pluralize(thread_data[:posts_count], "則回應") %></span>
          <span>建立於: <%= thread_data[:created_at] %></span>
        </div>
      </div>

      <!-- 顯示前5則貼文 -->
      <% thread.posts.order(created_at: :asc).first(5).each do |post| %>
        <% post_data = post_data(post) %>
        <div class="post-box">
          <div class="post-header">
            <% if post_data[:has_image] %>
              <span class="file-info">
                圖片檔名：
                <%= link_to post_data[:image_filename], post_data[:image_url], target: "_blank", class: "file-link" %>
                - (<%= number_to_human_size(post_data[:image_byte_size]) %>)
              </span><br>
            <% elsif post_data[:has_video] %>
              <span class="file-info">
                影片檔名：
                <%= link_to post_data[:video_filename], post_data[:video_url], target: "_blank", class: "file-link" %>
                - (<%= number_to_human_size(post_data[:video_byte_size]) %>)
              </span><br>
            <% end %>
            <span class="post-time">
              發表於：<%= post_data[:created_at] %>
            </span>
            <span class="post-id">ID: <%= post_data[:hashed_ip] %></span>
          </div>
          
          <div class="post-content">
            <span class="post-name"><%= post_data[:name].presence || "無名" %></span>：
            <p><%= simple_format(post_data[:content].presence || "無本文") %></p>
          </div>
          
          <% if post_data[:has_image] %>
            <img src="<%= post_data[:image_url] %>" class="post-image" alt="圖片" onclick="toggleImageSize(this)">
          <% elsif post_data[:has_video] %>
            <video controls class="post-video" preload="metadata" onclick="toggleVideoSize(this)">
              <source src="<%= post_data[:video_url] %>" type="<%= post_data[:video_content_type] %>">
              您的瀏覽器不支援影片播放。
            </video>
          <% elsif post_data[:has_youtube_links] %>
            <div class="youtube-container">
              <% post_data[:youtube_video_ids].each do |video_id| %>
                <div class="youtube-embed">
                  <iframe src="https://www.youtube.com/embed/<%= video_id %>"
                          width="560"
                          height="315"
                          frameborder="0"
                          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                          allowfullscreen
                          class="youtube-video">
                  </iframe>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </li>
  <% end %>
</ul>

<!-- 分頁 -->
<div class="pagination-container">
  <%= paginate @discussion_threads %>
</div>

<script>
  // 圖片點擊放大/縮小
  function toggleImageSize(img) {
    img.classList.toggle('expanded');
  }
  
  // 影片點擊放大/縮小
  function toggleVideoSize(video) {
    video.classList.toggle('expanded');
  }
</script>